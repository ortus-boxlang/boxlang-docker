name: Pull Request

on:
  pull_request:
    branches:
      - main
      - development

jobs:
  pr-tests:
    runs-on: ubuntu-latest
    env:
      DOCKER_IMAGE: 233317242204.dkr.ecr.us-east-1.amazonaws.com/tryboxlang
      BX_VERSION: 1.0.0
    strategy:
      matrix:
        include:
          # Alpine builds
          # Note: No JDK builders currently support alpine with ARM
          - BUILD_IMAGE_DOCKERFILE: builds/alpine/Base.Dockerfile
            BUILD_IMAGE_TAG: bx
          - BUILD_IMAGE_DOCKERFILE: builds/alpine/Base.Web.Dockerfile
            BUILD_IMAGE_TAG: bx-web
          - BUILD_IMAGE_DOCKERFILE: builds/alpine/Base.StayAlive.Dockerfile
            BUILD_IMAGE_TAG: bx-stayalive
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@master
        with:
          platforms: all

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@master

      - name: Test
        env:
          DOCKER_BUILDKIT: 1
          COMPOSE_DOCKER_CLI_BUILD: 1
          BUILD_IMAGE_DOCKERFILE: ${{ matrix.BUILD_IMAGE_DOCKERFILE }}
        run: |
          docker compose -f docker-compose.test.yml up --build --exit-code-from sut
          # docker compose -f docker-compose.secret-test.yml up --build --exit-code-from sut
